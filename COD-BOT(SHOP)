#–ë–û–¢ –ë–ï–ó –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö –°–ï–†–í–ï–†–£!!!
import asyncio
import sqlite3
from contextlib import closing
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

# ================== –ù–ê–°–¢–†–û–ô–ö–ò ==================
API_TOKEN = "7940054090:AAGftTHw-7OaXtn6ag_L74AN3EQGtnbkN3U"  # <-- –≤—Å—Ç–∞–≤—å —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
CURRENCY_RATE_RUB_TO_COINS = 1   # 1‚ÇΩ = 1 –º–æ–Ω–µ—Ç–∞
BANNER_IMAGE_URL = None          # –ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ –±–∞–Ω–Ω–µ—Ä–∞ –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å None
BANNER_TEXT = (
    "üéÆ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω –∏–≥—Ä–æ–≤–æ–π –≤–∞–ª—é—Ç—ã</b>\n\n"
    "–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –≤–∞–ª—é—Ç—É –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.\n"
    f"üí± <b>–ö—É—Ä—Å:</b> 1‚ÇΩ = {CURRENCY_RATE_RUB_TO_COINS} –º–æ–Ω–µ—Ç–∞\n"
)

# –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ (—Å–µ–π—á–∞—Å –æ–¥–∏–Ω, –Ω–æ –ª–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –¥–æ 5)
SERVERS = [
    {"id": "server_1", "title": "üåç –°–µ—Ä–≤–µ—Ä #1"},
    # {"id": "server_2", "title": "üåç –°–µ—Ä–≤–µ—Ä #2"},
]

DB_PATH = "game.db"

# ================== –ë–ê–ó–ê –î–ê–ù–ù–´–• ==================
def init_db():
    with closing(sqlite3.connect(DB_PATH)) as conn, conn, closing(conn.cursor()) as cur:
        cur.execute("""
            CREATE TABLE IF NOT EXISTS players (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                nickname TEXT UNIQUE,
                balance INTEGER DEFAULT 0
            )
        """)
        # –¢–µ—Å—Ç–æ–≤—ã–µ –∏–≥—Ä–æ–∫–∏
        cur.execute("INSERT OR IGNORE INTO players (nickname) VALUES (?)", ("Player1",))
        cur.execute("INSERT OR IGNORE INTO players (nickname) VALUES (?)", ("Player2",))

def get_player(nick: str):
    with closing(sqlite3.connect(DB_PATH)) as conn, closing(conn.cursor()) as cur:
        cur.execute("SELECT id, nickname, balance FROM players WHERE nickname=?", (nick,))
        return cur.fetchone()

def add_currency(nick: str, amount: int):
    with closing(sqlite3.connect(DB_PATH)) as conn, conn, closing(conn.cursor()) as cur:
        cur.execute("UPDATE players SET balance = balance + ? WHERE nickname=?", (amount, nick))

# ================== –°–û–°–¢–û–Ø–ù–ò–ï –°–ï–°–°–ò–ô ==================
# –ü—Ä–æ—Å—Ç–æ–µ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞ –ª—É—á—à–µ FSM/–ë–î.
# user_sessions[user_id] = {
#   "main_msg_id": int,
#   "server_id": str | None,
#   "nick": str | None,
#   "amount": int | None
# }
user_sessions = {}

# ================== –£–¢–ò–õ–ò–¢–´ UI ==================
def kb_main() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("üó∫Ô∏è –í—ã–±—Ä–∞—Ç—å —Å–µ—Ä–≤–µ—Ä", callback_data="ui_choose_server"))
    kb.add(InlineKeyboardButton("‚ÑπÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?", callback_data="ui_how"))
    return kb

def kb_servers() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup(row_width=1)
    for s in SERVERS:
        kb.add(InlineKeyboardButton(s["title"], callback_data=f"pick_server:{s['id']}"))
    kb.add(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="ui_back_home"))
    return kb

def kb_after_nick_confirmed() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("üí∞ –í–≤–µ—Å—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–ª—é—Ç—ã", callback_data="ui_enter_amount"))
    kb.add(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="ui_choose_server"))
    return kb

def kb_ready_to_pay() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å (—Ç–µ—Å—Ç)", callback_data="pay_now_fake"))
    kb.add(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="ui_enter_amount"))
    return kb

def kb_cancel_only() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="ui_back_home"))
    return kb

async def set_or_edit_main_message(message_or_callback, html_text: str, reply_markup: InlineKeyboardMarkup = None, use_photo: bool = False):
    """
    –î–µ—Ä–∂–∏–º –æ–¥–Ω–æ ¬´–≥–ª–∞–≤–Ω–æ–µ¬ª —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –µ–≥–æ.
    –ï—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º. –ï—Å–ª–∏ –µ—Å—Ç—å ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º.
    """
    if isinstance(message_or_callback, types.Message):
        chat_id = message_or_callback.chat.id
        user_id = message_or_callback.from_user.id
    else:
        # CallbackQuery
        chat_id = message_or_callback.message.chat.id
        user_id = message_or_callback.from_user.id

    session = user_sessions.get(user_id, {})
    main_msg_id = session.get("main_msg_id")

    # –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –±–∞–Ω–Ω–µ—Ä–∞ –≤ —Å–∞–º–æ–º –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
    if main_msg_id is None:
        if use_photo and BANNER_IMAGE_URL:
            sent = await bot.send_photo(
                chat_id=chat_id,
                photo=BANNER_IMAGE_URL,
                caption=html_text,
                parse_mode="HTML",
                reply_markup=reply_markup
            )
        else:
            sent = await bot.send_message(
                chat_id=chat_id,
                text=html_text,
                parse_mode="HTML",
                reply_markup=reply_markup
            )
        session["main_msg_id"] = sent.message_id
        user_sessions[user_id] = session
        return

    # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    try:
        if use_photo and BANNER_IMAGE_URL:
            # –ù–µ–ª—å–∑—è –∑–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –º–µ—Å—Å–µ–¥–∂ –Ω–∞ —Ñ–æ—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å—å, –µ—Å–ª–∏ —ç—Ç–æ —Ñ–æ—Ç–æ
            # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤—Å–µ–≥–¥–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç (caption) —É —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            await bot.edit_message_caption(
                chat_id=chat_id,
                message_id=main_msg_id,
                caption=html_text,
                parse_mode="HTML",
                reply_markup=reply_markup
            )
        else:
            await bot.edit_message_text(
                chat_id=chat_id,
                message_id=main_msg_id,
                text=html_text,
                parse_mode="HTML",
                reply_markup=reply_markup
            )
    except Exception:
        # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ/–Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º id
        sent = await bot.send_message(
            chat_id=chat_id,
            text=html_text,
            parse_mode="HTML",
            reply_markup=reply_markup
        )
        session["main_msg_id"] = sent.message_id
        user_sessions[user_id] = session

# ================== –ë–û–¢ ==================
bot = Bot(token=API_TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)

# -------- –ö–æ–º–∞–Ω–¥—ã --------
@dp.message_handler(commands=["start"])
async def cmd_start(message: types.Message):
    # –ß–∏—Å—Ç–∏–º –∫–æ–º–∞–Ω–¥—É /start (—á—Ç–æ–±—ã —á–∞—Ç –±—ã–ª —á–∏—Å—Ç—ã–º)
    try:
        await message.delete()
    except Exception:
        pass

    # –û–±–Ω—É–ª—è–µ–º/—Å–æ–∑–¥–∞—ë–º —Å–µ—Å—Å–∏—é
    user_sessions[message.from_user.id] = {
        "main_msg_id": None,
        "server_id": None,
        "nick": None,
        "amount": None
    }

    await set_or_edit_main_message(
        message,
        html_text=BANNER_TEXT + "\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∏–∂–µ üëá",
        reply_markup=kb_main(),
        use_photo=True  # –µ—Å–ª–∏ BANNER_IMAGE_URL —É–∫–∞–∑–∞–Ω ‚Äî –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–∫–∞–∑–µ –≤—ã–≤–µ–¥–µ—Ç—Å—è —Ñ–æ—Ç–æ
    )

@dp.message_handler(commands=["balance"])
async def cmd_balance(message: types.Message):
    args = message.get_args().strip()
    if not args:
        await message.reply("‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: <code>/balance –ù–ò–ö</code>")
        return

    player = get_player(args)
    if not player:
        await message.reply("‚ùå –ù–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    balance = player[2]
    await message.reply(f"üí∞ –ë–∞–ª–∞–Ω—Å –∏–≥—Ä–æ–∫–∞ <b>{args}</b>: <b>{balance}</b> –º–æ–Ω–µ—Ç")

# -------- –ù–∞–≤–∏–≥–∞—Ü–∏—è (Callback) --------
@dp.callback_query_handler(lambda c: c.data == "ui_back_home")
async def ui_back_home(callback: types.CallbackQuery):
    # –°–±—Ä–æ—Å–∏–º –≤–≤–æ–¥, –Ω–æ –æ—Å—Ç–∞–≤–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (–ø–æ –∂–µ–ª–∞–Ω–∏—é –º–æ–∂–Ω–æ –∏ —Å–µ—Ä–≤–µ—Ä —Å–±—Ä–æ—Å–∏—Ç—å)
    session = user_sessions.get(callback.from_user.id, {})
    session["nick"] = None
    session["amount"] = None
    user_sessions[callback.from_user.id] = session

    await set_or_edit_main_message(
        callback,
        html_text=BANNER_TEXT + "\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∏–∂–µ üëá",
        reply_markup=kb_main(),
        use_photo=False
    )
    await callback.answer()

@dp.callback_query_handler(lambda c: c.data == "ui_how")
async def ui_how(callback: types.CallbackQuery):
    text = (
        "üß≠ <b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</b>\n\n"
        "1) –í—ã–±–∏—Ä–∞–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä\n"
        "2) –í–≤–æ–¥–∏—Ç–µ –Ω–∏–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\n"
        "3) –í–≤–æ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç (1‚ÇΩ = 1 –º–æ–Ω–µ—Ç–∞)\n"
        "4) –û–ø–ª–∞—á–∏–≤–∞–µ—Ç–µ (–≤ –¥–µ–º–æ ‚Äî —Ç–µ—Å—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞)\n"
        "5) –í–∞–ª—é—Ç–∞ –∑–∞—á–∏—Å–ª—è–µ—Ç—Å—è –Ω–∞ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç\n\n"
        "–ö–æ–º–∞–Ω–¥–∞: <code>/balance –ù–ò–ö</code> ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å."
    )
    await set_or_edit_main_message(callback, text, kb_main())
    await callback.answer()

@dp.callback_query_handler(lambda c: c.data == "ui_choose_server")
async def ui_choose_server(callback: types.CallbackQuery):
    await set_or_edit_main_message(
        callback,
        html_text="üåê <b>–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä</b>:",
        reply_markup=kb_servers()
    )
    await callback.answer()

@dp.callback_query_handler(lambda c: c.data.startswith("pick_server:"))
async def pick_server(callback: types.CallbackQuery):
    server_id = callback.data.split(":")[1]
    session = user_sessions.get(callback.from_user.id, {})
    session["server_id"] = server_id
    session["nick"] = None
    session["amount"] = None
    user_sessions[callback.from_user.id] = session

    text = (
        f"‚úÖ –°–µ—Ä–≤–µ—Ä –≤—ã–±—Ä–∞–Ω: <b>{server_id}</b>\n\n"
        "–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.\n\n"
        "‚úçÔ∏è –û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ–º (—Ç–µ–∫—Å—Ç–æ–º).\n\n"
        "‚ÑπÔ∏è –î–ª—è —Ç–µ—Å—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω—ã: <code>Player1</code>, <code>Player2</code>"
    )
    await set_or_edit_main_message(callback, text, kb_cancel_only())
    await callback.answer()

@dp.callback_query_handler(lambda c: c.data == "ui_enter_amount")
async def ui_enter_amount(callback: types.CallbackQuery):
    session = user_sessions.get(callback.from_user.id, {})
    nick = session.get("nick")
    if not nick:
        await callback.answer("–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–∏–∫.", show_alert=True)
        return

    text = (
        f"üë§ –ü–µ—Ä—Å–æ–Ω–∞–∂: <b>{nick}</b>\n"
        f"üí± –ö—É—Ä—Å: 1‚ÇΩ = {CURRENCY_RATE_RUB_TO_COINS} –º–æ–Ω–µ—Ç–∞\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –∂–µ–ª–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç.\n"
        "‚úçÔ∏è –û—Ç–ø—Ä–∞–≤—å—Ç–µ —á–∏—Å–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ–º (—Ç–µ–∫—Å—Ç–æ–º).\n\n"
        "–ü—Ä–∏–º–µ—Ä: <code>150</code>"
    )
    await set_or_edit_main_message(callback, text, kb_cancel_only())
    await callback.answer()

@dp.callback_query_handler(lambda c: c.data == "pay_now_fake")
async def pay_now_fake(callback: types.CallbackQuery):
    session = user_sessions.get(callback.from_user.id, {})
    nick = session.get("nick")
    amount = session.get("amount")

    if not nick or not amount:
        await callback.answer("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö (–Ω–∏–∫/—Å—É–º–º–∞).", show_alert=True)
        return

    # –ò–º–∏—Ç–∏—Ä—É–µ–º ¬´—É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É¬ª –∏ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ
    add_currency(nick, amount)

    text = (
        "‚úÖ <b>–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!</b>\n\n"
        f"üí∞ –ó–∞—á–∏—Å–ª–µ–Ω–æ: <b>{amount}</b> –º–æ–Ω–µ—Ç\n"
        f"üë§ –ò–≥—Ä–æ–∫: <b>{nick}</b>\n\n"
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!\n\n"
        "üëâ –ú–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å: <code>/balance {nick}</code>"
    )
    await set_or_edit_main_message(callback, text, kb_main())
    # –°–±—Ä–æ—Å–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—É–º–º—ã
    session["amount"] = None
    user_sessions[callback.from_user.id] = session

    await callback.answer("–£—Å–ø–µ—à–Ω–æ!")

# -------- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤ (–≤–≤–æ–¥ –Ω–∏–∫–∞ / —Å—É–º–º—ã) --------
@dp.message_handler(content_types=types.ContentTypes.TEXT)
async def handle_text(message: types.Message):
    user_id = message.from_user.id
    session = user_sessions.get(user_id)

    # –ï—Å–ª–∏ –Ω–µ—Ç —Å–µ—Å—Å–∏–∏ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏–º /start
    if not session:
        await message.reply("–ù–∞–∂–º–∏ /start –¥–ª—è –Ω–∞—á–∞–ª–∞.")
        return

    # –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã —á–∞—Ç –æ—Å—Ç–∞–≤–∞–ª—Å—è —á–∏—Å—Ç—ã–º
    try:
        await message.delete()
    except Exception:
        pass

    # –í–≤–æ–¥ –Ω–∏–∫–∞ ‚Äî –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤—ã–±—Ä–∞–Ω, –∞ –Ω–∏–∫ –µ—â—ë –Ω–µ —É–∫–∞–∑–∞–Ω, –∏ –º—ã –Ω–∞ —à–∞–≥–µ –≤–≤–æ–¥–∞ –Ω–∏–∫–∞
    if session.get("server_id") and session.get("nick") is None:
        nick = message.text.strip()
        player = get_player(nick)
        if not player:
            txt = (
                "‚ùå <b>–ù–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω</b>.\n\n"
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.\n\n"
                "‚ÑπÔ∏è –î–ª—è —Ç–µ—Å—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω—ã: <code>Player1</code>, <code>Player2</code>"
            )
            await set_or_edit_main_message(message, txt, kb_cancel_only())
            return

        session["nick"] = nick
        user_sessions[user_id] = session

        txt = (
            f"‚úÖ –ù–∏–∫ –Ω–∞–π–¥–µ–Ω: <b>{nick}</b>\n\n"
            "–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–ª—é—Ç—ã –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥.\n"
            "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤–≤–µ—Å—Ç–∏ —Å—É–º–º—É."
        )
        await set_or_edit_main_message(message, txt, kb_after_nick_confirmed())
        return

    # –í–≤–æ–¥ —Å—É–º–º—ã ‚Äî –µ—Å–ª–∏ –Ω–∏–∫ —É–∂–µ –µ—Å—Ç—å, –∞ —Å—É–º–º–∞ –µ—â—ë –Ω–µ—Ç
    if session.get("nick") and session.get("amount") is None:
        raw = message.text.replace(" ", "")
        if not raw.isdigit():
            await set_or_edit_main_message(
                message,
                "‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ <b>—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ</b> –±–æ–ª—å—à–µ 0.",
                kb_cancel_only()
            )
            return

        amount = int(raw)
        if amount <= 0:
            await set_or_edit_main_message(
                message,
                "‚ö†Ô∏è –ß–∏—Å–ª–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å <b>–±–æ–ª—å—à–µ 0</b>.",
                kb_cancel_only()
            )
            return

        session["amount"] = amount
        user_sessions[user_id] = session

        total_rub = amount  # –ø—Ä–∏ –∫—É—Ä—Å–µ 1:1
        txt = (
            f"üßæ <b>–°—á—ë—Ç –∫ –æ–ø–ª–∞—Ç–µ (–¥–µ–º–æ)</b>\n\n"
            f"üë§ –ü–µ—Ä—Å–æ–Ω–∞–∂: <b>{session['nick']}</b>\n"
            f"üí∞ –ú–æ–Ω–µ—Ç—ã: <b>{amount}</b>\n"
            f"üíµ –ö –æ–ø–ª–∞—Ç–µ: <b>{total_rub}‚ÇΩ</b>\n\n"
            "–ù–∞–∂–º–∏—Ç–µ ¬´–û–ø–ª–∞—Ç–∏—Ç—å (—Ç–µ—Å—Ç)¬ª —á—Ç–æ–±—ã –∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–ª–∞—Ç—É."
        )
        await set_or_edit_main_message(message, txt, kb_ready_to_pay())
        return

    # –ï—Å–ª–∏ –º—ã –∑–¥–µ—Å—å ‚Äî –∑–Ω–∞—á–∏—Ç —à–∞–≥ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω
    await set_or_edit_main_message(
        message,
        "‚ÑπÔ∏è –ù–∞–∂–º–∏—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –º–µ–Ω—é –Ω–∏–∂–µ.",
        kb_main()
    )

# ================== –ó–ê–ü–£–°–ö ==================
if __name__ == "__main__":
    init_db()
    print("Bot is running...")
    executor.start_polling(dp, skip_updates=True)

